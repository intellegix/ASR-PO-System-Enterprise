# ASR Purchase Order System - Render PostgreSQL Deployment
# Full-stack deployment with managed PostgreSQL database

services:
  # PostgreSQL Database Service
  - type: pserv
    name: asr-po-database
    region: oregon
    plan: starter # starter ($7/month) | standard ($20/month) | pro ($90/month)
    databaseName: po_system
    databaseUser: po_admin

  # Main Application Service
  - type: web
    name: asr-po-system
    runtime: node
    repo: https://github.com/Intellegix/ASR-PO-System-Enterprise.git
    branch: master
    region: oregon # Change to preferred region: oregon, ohio, singapore, ireland
    plan: starter # starter ($7/month) | standard ($25/month) | pro ($85/month)

    # Environment Configuration
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXTAUTH_URL
        value: https://asr-po-system.onrender.com
      - key: PORT
        value: 3000

      # Database Configuration (PostgreSQL)
      - key: DATABASE_URL
        fromService:
          type: pserv
          name: asr-po-database
          property: connectionString

      # Authentication & Security
      - key: NEXTAUTH_SECRET
        generateValue: true

      # JWT secrets for API authentication
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true

      # Email Configuration (requires manual setup)
      - key: SMTP_HOST
        sync: false # Set manually in Render dashboard
      - key: SMTP_PORT
        value: 587
      - key: SMTP_SECURE
        value: false
      - key: SMTP_USER
        sync: false # Set manually in Render dashboard
      - key: SMTP_PASS
        sync: false # Set manually in Render dashboard
      - key: SMTP_FROM
        sync: false # Set manually in Render dashboard

      # Monitoring & Logging
      - key: LOG_LEVEL
        value: info
      - key: ENABLE_AUDIT_LOGGING
        value: true

      # Performance Configuration
      - key: CACHE_TTL
        value: 300
      - key: MAX_CONCURRENT_USERS
        value: 100

    # Health Check Configuration
    healthCheckPath: /api/health

    # Build Configuration
    buildCommand: |
      cd web &&
      npm ci --production=false &&
      npx prisma generate &&
      npm run build

    startCommand: |
      cd web &&
      npx prisma migrate deploy &&
      npm start

    # Scaling Configuration
    autoDeploy: true
    preDeployCommand: |
      cd web &&
      npm run type-check

    # Dependencies - web service depends on database
    envVarsFromService:
      - fromService:
          type: pserv
          name: asr-po-database
          envVarKey: DATABASE_URL

# Estimated Monthly Cost: $14/month (starter plans)
# - Web Service: $7/month
# - PostgreSQL Service: $7/month

# Production Scaling Options:
# Standard Plan: $25/month
# - Web Service: $25/month (better performance, more CPU/RAM, 20GB SSD)

# ============================================================================
# DEPLOYMENT INSTRUCTIONS
# ============================================================================

# 1. Create Render Account: https://render.com/register
# 2. Connect GitHub Repository
# 3. Deploy using this Blueprint:
#    - Go to Render Dashboard
#    - Click "New" â†’ "Blueprint"
#    - Select GitHub repository
#    - Render will create the service automatically
# 4. Configure Environment Variables:
#    - SMTP credentials for email notifications (optional)
# 5. Verify Deployment:
#    - Check health endpoint: https://asr-po-system.onrender.com/api/health
#    - Test authentication and basic functionality

# ============================================================================
# POST-DEPLOYMENT CONFIGURATION
# ============================================================================

# Optional Manual Configuration:
# 1. Email (SMTP) Configuration:
#    - Set SMTP_HOST, SMTP_USER, SMTP_PASS, SMTP_FROM in Render dashboard
#    - Recommended: SendGrid, Mailgun, or AWS SES
#
# 2. SSL Certificate:
#    - Render provides automatic SSL certificates
#    - Custom domain configuration available in dashboard
#
# 3. Monitoring Setup:
#    - Configure monitoring tools using deployment/monitoring-alerting-config.yml
#    - Set up alerts for application health

# ============================================================================
# POSTGRESQL FEATURES
# ============================================================================

# Advantages:
# - Multi-user concurrent access
# - Built-in replication and backup
# - Advanced analytics capabilities
# - Managed service with automatic updates

# Features:
# - Concurrent read/write operations
# - Advanced indexing and query optimization
# - JSON/JSONB support for flexible data
# - Full ACID compliance

# Suitable for:
# - Small to enterprise businesses (unlimited concurrent users)
# - Complex business logic and reporting
# - High-volume write operations
# - Scalable production applications

# ============================================================================
# BACKUP STRATEGY
# ============================================================================

# PostgreSQL Database Backup:
# - Render automatically backs up PostgreSQL databases
# - Point-in-time recovery available
# - Additional backup options:
#   1. Periodic pg_dump exports via API
#   2. Automated backup to external storage (S3, etc.)
#   3. Database snapshots before major updates

# ============================================================================
# SCALING CONSIDERATIONS
# ============================================================================

# When to consider upgrading PostgreSQL plan:
# - More than 1000 concurrent users (Standard plan)
# - Complex analytics workloads
# - Multi-region deployment requirements
# - High-availability requirements

# Upgrade path to higher PostgreSQL plans:
# 1. Monitor database performance metrics
# 2. Upgrade to Standard plan ($20/month) for better performance
# 3. Upgrade to Pro plan ($90/month) for enterprise features
# 4. Consider read replicas for high-traffic applications

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================

# Automatic Security Features:
# - HTTPS/TLS encryption (Let's Encrypt certificates)
# - DDoS protection
# - Encrypted environment variables
# - Regular security updates

# Application Security (configured in application):
# - CSRF protection
# - Rate limiting
# - Input validation
# - Audit logging
# - Session security